---
- name: Ensure Firstboot Completion Verification
  delegate_to: "{{ target_host }}"
  tags: ['firstboot']
  ignore_errors: '{{ firstboot_ignore_errors | default(True) }}'
  register: firstboot_result
  until: firstboot_result.matched
  retries: 60
  delay: '{{ firstboot_delay | default(30) }}'
  find:
    paths: "/var/log/"
    patterns: "firstboot_verify.log"
    contains: "Firstboot.*Operations.*Completed.*Successfully"

- name: Report Firstboot Operations Success
  debug:
    msg: "Firstboot Operations Succeeded"
  when: firstboot_result.matched == 1

- name: Report Firstbook Operations Failure
  fail:
    msg: "Firstboot Operations Failed"
  when: firstboot_result.matched != 1
