---
#- hosts: planet
#  gather_facts: no
#  strategy: free
#  tasks:
#  - block:
#    - debug:
#        msg: Checking that server ({{ ansible_host }}) is available
#
#    - name: Waiting for servers to be available...
#      become: no
#      local_action: wait_for host='{{ ansible_host }}' port={{ ansible_port }} state=started delay=60 timeout='{{ server_restart_timeout | d(720) }}'
#  tags:
#  - cache
#  - os-pre-req
#  - apigee-pre-req
#  - dc-1
#  - dc-2
#  - apigee-logs
#  - logs
#  - os-logs
#  - ds

- include: configuration/update_cache.yml
  tags:
  - cache
  - os-pre-req
  - apigee-pre-req
  - ms
  - ds
  - qpid
  - pgmaster
  - pgstandby

- include: configuration/load-opdk-credentials.yml
  vars:
    hosts: 'planet'
  tags:
  - credentials
  - os-pre-req
  - apigee-pre-req

- include: configuration/opdk-setup-os.yml
  vars:
    hosts: 'planet'
  tags:
  - os
  - os-pre-req

- include: configuration/update-user.yml
  vars:
    hosts: 'planet'
    user: 'root'
  tags:
  - root-user

- include: components/opdk-pre-requisites.yml
  vars:
    hosts: 'planet'
    jdk_version: '1.8'
  tags:
  - apigee-pre-req

- include: components/opdk-install-component.yml
  vars:
    hosts: 'dc-1-ds'
    component_profile: 'ds'
  tags:
  - ds

- include: components/opdk-install-component.yml
  vars:
    hosts: 'dc-1-ms'
    component_profile: 'ms'
  tags:
  - ms

- include: configuration/opdk-set-reachable.yml
  vars:
    hosts: 'dc-1-rmp'
    reachability: 'false'
  tags:
  - rmp

- include: components/opdk-install-component.yml
  vars:
    hosts: 'dc-1-rmp'
    component_profile: 'rmp'
  tags:
  - rmp

- include: configuration/opdk-set-reachable.yml
  vars:
    hosts: 'dc-1-rmp'
    reachability: 'true'
  tags:
  - rmp

- include: components/opdk-install-component.yml
  vars:
    hosts: 'dc-1-qpid'
    component_profile: 'qs'
  tags:
  - qpid

- include: components/opdk-setup-postgres-common.yml
  vars:
    hosts: 'dc-1-pgmaster'
    pg_component: 'master'
  tags:
  - pgmaster

- include: components/opdk-setup-postgres-common.yml
  vars:
    hosts: 'dc-1-pgstandby'
    pg_component: 'standby'
  tags:
  - pgstandby

- include: configuration/opdk-setup-org-config.yml
  vars:
    hosts: 'dc-1-ms'
  tags:
  - org

- include: configuration/opdk-setup-org.yml
  vars:
    hosts: 'dc-1-ms'
  tags:
  - org

- include: validations/opdk-setup-validate.yml
  vars:
    hosts: 'dc-1-rmp'
  tags:
  - validation

- include: validations/opdk-internal-port-connectivity-validator.yml
  tags:
  - port-validator

- include: validations/opdk-setup-status.yml
  vars:
    hosts: 'planet'
  tags:
  - status

- include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-1-ds
  tags:
  - logs
  - dc-1

- include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-1-ms
  tags:
  - logs
  - dc-1

- include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-1-rmp
  tags:
  - logs
  - dc-1

- include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-1-qpid
  tags:
  - logs
  - dc-1

- include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-1-pgmaster
  tags:
  - logs
  - dc-1

- include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-1-pgstandby
  tags:
  - logs
  - dc-1


