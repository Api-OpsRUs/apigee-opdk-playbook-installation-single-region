---
- name: Request Netgroup AWS Access for node
  tags: ['netgroup']
  uri:
    url: https://vwebsac.verizon.com/OneAccessCloudServices/ITSecurity/AccessServices/RequestAccess
    method: POST
    headers:
      'Authorization': 'Basic QVBJR0VFX1VzZXI6IXZ6R0B0M3dheUAxIQ=='
      'Cache-Control': 'no-cache'
    body_format: json
    body:
      Users:
      - { EID: 'CM10002583' }
      Environment: 'NONPROD'
      Hosts:
      -  Name: "{{ item.private_ip | regex_replace('\\.','-') }}.ebiz.verizon.com"
      VastID: 24824
      Role: "SRVCACCT"
      OS: "linux"
  with_items: '{{ result.instances }}'

- name: Application Netgroup Verification
  find:
    paths: "/etc/security"
    patterns: "access-sshd.conf"
    contains: ".*D0MV_SRVCACCT_.*PROD_ONSHORE.*"
  ignore_errors: yes
  register: app_netgroup
  until: app_netgroup.matched
  retries: 20
  delay: 30

- name: Verify Netgroup has passed"
  cache:
    key: "app_netgroup_success"
    value: "{{ app_netgroup.matched == 1 | bool }}"

- name: Report Verify App Netgroup Success Status
  debug:
    msg: "App Netgroup Success Status: {{ app_netgroup_success }}"

